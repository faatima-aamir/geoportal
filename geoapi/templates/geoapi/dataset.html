{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dataset Explorer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
   <style>
    body {
        margin: 0;
        font-family: 'Segoe UI', sans-serif;
        background-image: url("{% static 'images/background.jpg' %}");
        background-size: cover;
        background-attachment: fixed;
        background-position: center;
        color: #2e2f30;
    }

    .header {
        background-color: #4a596b; /* neutral slate */
        color: white;
        padding: 0.6rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .header h1 {
        font-size: 1.4rem;
        margin: 0;
    }

    .logout-button {
        background-color: #3e4a5e;
        color: white;
        border: none;
        padding: 0.4rem 0.9rem;
        border-radius: 5px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .logout-button:hover {
        background-color: #5c6d80;
    }

    .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .dataset-card {
        background: rgba(255, 255, 255, 0.766);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        transition: transform 0.2s ease;
        position: relative;
    }

    .dataset-card:hover {
        transform: translateY(-5px);
    }

    .thumbnail {
        width: 100%;
        height: 160px;
        background-color: #d4d4d4;
        background-image: url("{% static 'images/map_placeholder.jpg' %}");
        background-size: cover;
        background-position: center;
    }

    .card-body {
        padding: 1rem;
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
        color: #2e3c4f;
    }

    .card-meta {
        font-size: 0.9rem;
        color: #555e66;
    }

    .card-footer {
        padding: 0.8rem 1rem;
        display: flex;
        justify-content: space-between;
        border-top: 1px solid #eee;
    }

    .card-footer a {
        text-decoration: none;
        color: #4a596b;
        font-weight: 500;
        transition: color 0.2s;
    }

    .card-footer a:hover {
        color: #2f3d4d;
    }
    #chatbot {
    color: #ffffff; /* sets default text color inside the chatbox */
}

#chat-messages {
    color: #ffffff; /* ensures messages appear white */
}

#chat-messages div {
    color: #ffffff; /* forces text inside each message div to be white */
}

#chat-input {
    color: #ffffff;
    background-color: #2c3e50;
    border: 1px solid #4a596b;
}

#chat-input::placeholder {
    color: #cccccc;
}
</style>

</head>
<body>
    <div class="header">
        <h1>üìö GeoDataset Explorer</h1>
        <form action="{% url 'logout_view' %}" method="post" style="margin: 0;">
            {% csrf_token %}
            <button type="submit" class="logout-button">Logout</button>
        </form>
    </div>

    <div class="container">
        <div class="grid">
            {% for dataset in datasets %}
            <div class="dataset-card">
                <div class="thumbnail"></div>
                <div class="card-body">
                    <div class="card-title">{{ dataset.name }}</div>
                    <div class="card-meta">
                        Owner: {{ dataset.owner }}<br>
                        Last Updated: {{ dataset.updated }}
                    </div>
                </div>
                <div class="card-footer">
                    <a href="{{ dataset.view_url }}">View</a>
                    <a href="{{ dataset.metadata_url }}">Metadata</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <div id="chatbot" style="...">
    <div style="padding:10px; background:#3e4a5e; color:white;">Geo Chat</div>
    <div id="chat-messages" style="flex:1; padding:10px; overflow-y:auto;"></div>
    <div style="display:flex; padding:10px;">
        <input type="text" id="chat-input" style="flex:1;" placeholder="Ask a GIS question...">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>
<script>
    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;

        const chat = document.getElementById('chat-messages');
        chat.innerHTML += `<div><strong>You:</strong> ${msg}</div>`;
        input.value = "";

        const response = await fetch("/geo-chat/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: msg })
        });

        if (!response.ok || !response.body) {
            chat.innerHTML += `<div><strong>GeoBot:</strong> ‚ö†Ô∏è Server error.</div>`;
            return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let full = "";
        let botMsg = document.createElement("div");
        botMsg.innerHTML = "<strong>GeoBot:</strong> ";
        chat.appendChild(botMsg);

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const matches = [...chunk.matchAll(/data:\s?(.*)/g)];

            for (const match of matches) {
                const token = match[1];
                full += token;
                botMsg.innerHTML = `<strong>GeoBot:</strong> ${full}`;
                chat.scrollTop = chat.scrollHeight;
            }
        }
    }
</script>

</body>
</html>
